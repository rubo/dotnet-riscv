name: Linux riscv64

on:
  push:
    branches: [test/riscv64]
  workflow_dispatch:
    inputs:
      sdk:
        description: "URL of the dotnet sdk"
        required: false
      nupkg:
        description: "URL of the dotnet nupkg"
        required: false

jobs:
  run:
    runs-on: ubuntu-22.04
    steps:
      - name: Check out
        uses: actions/checkout@v4
      - uses: uraimo/run-on-arch-action@v2
        with:
          arch: riscv64
          distro: ubuntu22.04
          install: |
            apt-get update && apt-get install -y curl git libicu-dev software-properties-common
            add-apt-repository ppa:ubuntu-toolchain-r/test
            apt-get update && apt-get install --only-upgrade -y libstdc++6
          run: |
            echo "Downloading SDK"
            curl -sL ${{ github.event.inputs.sdk || 'https://b7ltda.db.files.1drv.com/y4mNIvGEKxembSln3JBRlfA2zD4BD8YzTlar_3JqwNK4M2zW5YKCdSvThvturpe18vlSO2aWEMmWlmIdvtMuDKZWX2xnalb7RcyUjsUDFUOhSbPJTgm6PIDZITzxiwPawunLWI-YgupBmGXLhEZ8UG0c7x78Eh7cG79wftHHbbwJJ3WAMLhl9t0qv1DRrAbkrpws0aXv2LHwc2UVB5ynGZ9Laasq9OOmOaPszi-L5rT4ow?AVOverride=1' }} -o dotnet.tar.gz
            #echo "Downloading NuGet packages"
            #curl -sL ${{ github.event.inputs.nupkg || 'https://cllqda.db.files.1drv.com/y4mqSe4TK8P-7oojLaiJFBECMThnmwaD94nFltbbD5H6s5TSKeE5MpxnsGwtHcTlG3yRv3vlXCqGJ4j_2RvRWFRWBNd0hbB74w9ljS3bGNkuVJaOY6mA1anezvbYIGskJ9PlW_xsTs0ZGzkPgWC1SSa6jk0_q5LAHUdCjMmo-nFNZ4hkiAp4hdFusGsqnKptzTxOf8lY7Fk38wM-BdsfilODTjw1t7dzn2graFDRFA4FGg?AVOverride=1' }} -o nupkg.tar
            #mkdir -p nupkg
            #tar -xf nupkg.tar -C nupkg
            mkdir -p sdk
            tar -xf dotnet.tar.gz -C sdk
            cd sdk
            ldd ./dotnet
            echo "Creating a new app"
            ./dotnet new console -n MyConsoleApp
            #mv ../nuget.config ./MyConsoleApp/nuget.config
            echo 'Console.WriteLine("ðŸŽ„ Merry Christmas from .NET on riscv64 ðŸŽ…");' >> ./MyConsoleApp/Program.cs
            echo "Building the app"
            #./dotnet publish ./MyConsoleApp/MyConsoleApp.csproj -c release -r linux-riscv64 -o ./MyConsoleApp/pub --sc true -p:PublishSingleFile=true
            ls ./MyConsoleApp/pub
            ./dotnet build ./MyConsoleApp/MyConsoleApp.csproj
            echo "Running test app..."
            ./MyConsoleApp/pub/MyConsoleApp
            #./dotnet ./MyConsoleApp/bin/Debug/net8.0/MyConsoleApp.dll
            uname -a
